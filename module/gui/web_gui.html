<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="charset=UTF-8, width=device-width, initial-scale=1">
    <title>HDTN GUI</title>
    <script src="plotly-2.6.3.min.js"></script>
</head>

<body>

<style>
    body {
        margin:0;
        font-family: Arial, Helvetica, sans-serif;
        background-color: #121212;
    }

    .topnav {
        overflow: hidden;
        background-color:#7f7f7f;
    }

    .topnav a {
        float: left;
        color: #f2f2f2;
        text-align: center;
        padding: 14px 16px;
        text-decoration: none;
        font-size: 17px;
    }

    .topnav a:hover {
        background-color: #ddd;
        color: black;
    }

    .topnav a.active {
        background-color: #04AA6D;
        color: white;
    }
    
    .rate_table {
        table-layout: fixed;
        background-color: #7f7f7f;
        color: white;
        font-size: 20px;
        text-align: center;
        width: 600px;
    }

    .rate_table th {
        background-color: #04AA6D;
        color: white;
    }

    .rate_table td {
        color: white;
    }


    .engine_table {
        table-layout: fixed;
        background-color: #7f7f7f;
        color: white;
        font-size: 20px;
        text-align: left;
        width: 1150px;
    }

    .engine_table th {
        background-color: #04AA6D;
        color: white;
    }

    .engine_table td {
        color: white;
    }

    .engine_table tr:nth-child(odd) {
        background-color: #404040;
    }

    .engine_table tr td:nth-child(even){
        text-align: center;
    }

</style>

<div class="topnav">
    <a class="active" href="#home">HDTN</a>
    <a href = "#stats">Statistics</a>
    <a href = "#config">Config</a>
</div>

<div id="data_rate_graph" style="width:600px;height:450px;float:left;padding-left:16px;padding-top:16px"></div>

<div id="storage_egress_chart" style="width:500px;height:450px;overflow:hidden;padding-left:50px;padding-top:16px"></div>

<div id="rate_stats" style="width:1000px;height:75px;padding-left:16px;padding-top:16px;">
<table class="rate_table">
    <tr>
        <th>Max Rate</th>
        <th>Average Rate</th>
        <th>Total Data (Mb)</th>
        <th>Total Bundles</th>
    </tr>
    <tr>
        <td id="max_data">0</td>
        <td id="avg_data">0</td>
        <td id="total_data">0</td>
        <td id="total_bundles">0</td>
    </tr>
</table>
</div>

<div id="engine_stats" style="width:1200px;padding-left:16px;padding-top:16px;padding-bottom:16px;">
<table class="engine_table">
    <colgroup>
        <col span="1" style="width:40%;"></col>
        <col span="1" style="width:10%;"></col>
        <col span="1" style="width:40%;"></col>
        <col span="1" style="width:10%;"></col>
    </colgroup>
    <tr>
        <th colspan="4" style="text-align:center">LTP Engine Information</th>
    </tr>
    <tr>
        <td>Count Async Send Calls</td>
        <td id="countAsyncSendCalls">0</td>
        <td>Count Circular Buffer Overruns</td>
        <td id="countCircularBufferOverruns">0</td>
    </tr>
    <tr>
        <td>Num Checkpoint Timer Expired Callbacks</td>
        <td id="numCheckpointTimerExpiredCallbacks">0</td>
        <td>Num Discretionary Checkpoints Not Resent</td>
        <td id="numDiscretionaryCheckpointsNotResent">0</td>
    </tr>
    <tr>
        <td>Num Report Segment Timer Expired Callbacks</td>
        <td id="numReportSegmentTimerExpiredCallbacks">0</td>
        <td>Num Report Segments Unable To Be Issued</td>
        <td id="numReportSegmentsUnableToBeIssued">0</td>
    </tr>
    <tr>
        <td>Num Report Segments Too Large And Needing Split</td>
        <td id="numReportSegmentsTooLargeAndNeedingSplit">0</td>
        <td>Num Report Segments Created Via Split</td>
        <td id="numReportSegmentsCreatedViaSplit">0</td>
    </tr>
    <tr>
        <td>Expected Session Originator Engine ID</td>
        <td id="expectedSessionOriginatorEngineId">0</td>
        <td>Total Data Segments Sent Successfully With Ack</td>
        <td id="totalDataSegmentsSentSuccessfullyWithAck">0</td>
    </tr>
    <tr>
        <td>Total Data Segments Failed To Send</td>
        <td id="totalDataSegmentsFailedToSend">0</td>
        <td>Total Data Segments Sent</td>
        <td id="totalDataSegmentsSent">0</td>
    </tr>
    <tr>
        <td>Total Bundle Bytes Sent</td>
        <td id="totalBundleBytesSent">0</td>
        <td>Total STCP Bytes Sent</td>
        <td id="totalStcpBytesSent">0</td>
    </tr>
    <tr>
        <td>Total Data Segments Acked By TCP Send Callback</td>
        <td id="totalDataSegmentsAckedByTcpSendCallback">0</td>
        <td>Total Bytes Acked By TCP Send Callback</td>
        <td id="totalBytesAckedByTcpSendCallback">0</td>
    </tr>
    <tr>
        <td>Ingress Bundle Count Storage</td>
        <td id="ingressBundleCountStorage">0</td>
        <td>Ingress Bundle Count Egress</td>
        <td id="ingressBundleCountEgress">0</td>
    </tr>
    <tr>
        <td>Ingress Bundle Count</td>
        <td id="ingressBundleCount">0</td>
        <td>Ingress Bundle Data</td>
        <td id="ingressBundleData">0</td>
    </tr>
    <tr>
        <td>Egress Message Count</td>
        <td id="egressMessageCount">0</td>
        <td>Egress Bundle Count</td>
        <td id="egressBundleCount">0</td>
    </tr>
    <tr>
        <td>Egress Bundle Data</td>
        <td id="egressBundleData">0</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>Total Bundles Erased From Storage</td>
        <td id="totalBundlesErasedFromStorage">0</td>
        <td>Total Bundles Sent To Egress From Storage</td>
        <td id="totalBundlesSentToEgressFromStorage">0</td>
    </tr>

</table>
</div>

<label>IP:</label>
<input type="text" id="id_ip" value="10.0.2.16">
<label>Port:</label>
<input type="text" id="id_port" value="8086">
<button onclick="ConnectToServer()">Connect</button>

<script type="text/javascript">
    
    var rate_data = [{
        x: [],
        y: [],
        type: 'scatter',
        line: {
            color: "aqua"
        }
    }];

    var rateCount = 0;

    var layout = {
        title: 'HDTN Data Rates',
        paper_bgcolor: "#404040",
        plot_bgcolor: "#404040",
        xaxis: {
            title: "Timestamp (s)",
        },
        yaxis: {
            title: "Data Rate (Mbps)",
        },
        font:{
            family: "Arial",
            size: 18,
            color: "white"
        }
    };

    GRAPH = document.getElementById("data_rate_graph");

    Plotly.newPlot(GRAPH, rate_data, layout);

    var pie_data = [{
        values: [29,71],
        labels: ['Storage', 'Egress'], 
        type: 'pie'
    }];

    var pie_layout = {
        title: 'Bundle Destinations',
        height: 500,
        width:500,
        paper_bgcolor: "#404040",
        font:{
            family: "Arial",
            size: 18,
            color: "white"
        }
    };

    Plotly.newPlot('storage_egress_chart', pie_data, pie_layout);

    function UpdateData(objJson){
        if("bundleDataRate" in objJson){
            rate_data[0]['x'].push(rateCount++);
            rate_data[0]['y'].push(parseFloat(objJson.bundleDataRate));
            console.log(rate_data[0]['y']);
            Plotly.update(GRAPH, rate_data, layout);
            document.getElementById("max_data").innerHTML = Math.max.apply(Math, rate_data[0].y).toFixed(2);
        }
        if("averageRate" in objJson){
            document.getElementById("avg_data").innerHTML = parseFloat(objJson.averageRate).toFixed(2);
        }
        if("totalData" in objJson){
            document.getElementById("total_data").innerHTML = parseFloat(objJson.totalData).toFixed(2);
            document.getElementById("ingressBundleData").innerHTML = parseFloat(objJson.totalData).toFixed(2);
        }
        if("bundleCountStorage" in objJson && "bundleCountEgress" in objJson){
            pie_data[0]['values'] = [parseInt(objJson.bundleCountStorage), parseInt(objJson.bundleCountEgress)];
            Plotly.update('storage_egress_chart', pie_data, pie_layout);

            document.getElementById("total_bundles").innerHTML = parseInt(objJson.bundleCountStorage) + parseInt(objJson.bundleCountEgress);
            document.getElementById("ingressBundleCountStorage").innerHTML = objJson.bundleCountStorage;
            document.getElementById("ingressBundleCountEgress").innerHTML = objJson.bundleCountEgress;
            document.getElementById("ingressBundleCount").innerHTML = parseInt(objJson.bundleCountStorage) + parseInt(objJson.bundleCountEgress);

        }
        if("egressBundleCount" in objJson){
            document.getElementById("egressBundleCount").innerHTML = objJson.egressBundleCount;
        }
        if("egressBundleData" in objJson){
            document.getElementById("egressBundleData").innerHTML = parseFloat(objJson.egressBundleData).toFixed(2);
        }
        if("egressMessageCount" in objJson){
            document.getElementById("egressMessageCount").innerHTML = objJson.egressMessageCount;
        }
        if("totalBundlesErasedFromStorage" in objJson){
            document.getElementById("totalBundlesErasedFromStorage").innerHTML = objJson.totalBundlesErasedFromStorage;
        }
        if("totalBundlesSentToEgressFromStorage" in objJson){
            document.getElementById("totalBundlesSentToEgressFromStorage").innerHTML = objJson.totalBundlesSentToEgressFromStorage;
        }

    }

    function ConnectToServer(){
        var toSend="CONNECT " + document.getElementById("id_ip").value + " " + document.getElementByID("id_port").value;
        console.log(toSend);
        connection.send(toSend);
    }

    window.addEventListener("load", function(event){
        if(!("WebSocket" in window)){
            alert("WebSocket is not supported by your Browser!");
        }

    var wsproto = (location.protocol === 'http:') ? 'ws:' : 'ws:';
    connection = new WebSocket(wsproto + '//' + window.location.host + '/websocket');
    connection.binaryType = "arraybuffer";

    //When connection is established
    connection.onopen = function(){
        console.log("ws opened");
    }

    //When connection is closed
    connection.onclose = function(){
        console.log("ws closed");
    }

    //When client receives data from server
    connection.onmessage = function(e){
        console.log("rcvd");
        //if binary data
        if(e.data instanceof ArrayBuffer){
            var dv = new DataView(e.data);
        }
        //else this is text data
        else{
            if(e.data === "Hello websocket"){
                console.log(e.data);
            }
            else{
            try{
                console.log(e.data);
                var obj = JSON.parse(e.data); //could error based on encodings
                console.log("JSON data parsed");
                UpdateData(obj);
            }
            catch(err){
                console.log(err.message);
            }}
        }
    }
    });

</script>


</body>
</html>
