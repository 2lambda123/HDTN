<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="charset=UTF-8, width=device-width, initial-scale=1">
    <title>HDTN CONFIG</title>
</head>
<body>
    <div class="topnav">
        <a href="./hdtn_d3_gui/"> <span class="icon"><img src="./resources/home.svg" alt="Home icon" /></span><span class="title"> System View GUI</span></a>
        <a href="./index.html"><img src="./resources/statistics.svg" alt="Pie chart icon" /> Statistics</a>
        <a href="./config_page.html"><img src="./resources/config.svg" alt="Wrench icon" /> Config</a>
        <a onclick="toggleModes()"><img src="./resources/sun.svg" alt="Sun icon" /></a>
    </div>
    <div class="configBox" id="systemConfig">
        <div class="cardTitle">
            <h2>System</h2>
        </div>
    <div id="systemTable"></div>
    </div>
    <div class="configBox" id="inductConfig">
        <div class="cardTitle">
            <h2>Induct</h2>
        </div>
        <div id="inductTable">
        </div>
    </div>
    <div class="configBox">
        <div class="cardTitle">
            <h2>Outduct</h2>
        </div>
        <div id="outductTable">
        </div>
    </div>
    <div class="configBox">
        <div class="cardTitle">
            <h2>Storage</h2>
        </div> 
        <div id="storageTable">
        </div>
    </div>
</div>
    <link type="text/css" rel="stylesheet" href="./css/style.css" />
    <script type="text/javascript" src="./Scripts/plotly-2.6.3.min.js"></script>                             
    <script type="text/javascript">
        let hdtnConfig=null;

        function toggleModes() {
            var element = document.body;
            element.classList.toggle("light-mode");
        }

        function HandleReceivedNewHdtnConfig(hdtnConfig) {
            console.log(hdtnConfig);
            var inductsConfig = hdtnConfig.inductsConfig;
            var outductsConfig = hdtnConfig.outductsConfig;
            var storageConfig = hdtnConfig.storageConfig;
            delete hdtnConfig.inductsConfig;
            delete hdtnConfig.outductsConfig;
            delete hdtnConfig.storageConfig;

            document.getElementById('systemTable').innerHTML = JSON.stringify(hdtnConfig, null, '\t');
            document.getElementById('inductTable').innerHTML = JSON.stringify(inductsConfig, null, '\t');
            document.getElementById('outductTable').innerHTML = JSON.stringify(outductsConfig, null, '\t');
            document.getElementById('storageTable').innerHTML = JSON.stringify(storageConfig, null, '\t');                     
        }

        function UpdateWithData(objJson) {
            //console.log(objJson);
            if("hdtnConfigName" in objJson) {
                HandleReceivedNewHdtnConfig(objJson);
            }
            else if(hdtnConfig == null) {
                console.log("error, out of order command, hdtnConfig must be received first");
            }
            else {
                //HandleReceivedNewHdtnConfig(objJson);
            }
        }
    var connection = null;
    window.addEventListener("load", function(event) {
        console.log("All resources finished loading!");

        //if(typeof INITIAL_HDTN_CONFIG !== 'undefined'){
        //    UpdateWithData(INITIAL_HDTN_CONFIG);
        //}
        //else 
        if (!("WebSocket" in window)) {
            alert("WebSocket is not supported by your Browser!");
        }
        else {
            var wsproto = (location.protocol === 'https:') ? 'wss:' : 'ws:';
            connection = new WebSocket(wsproto + '//' + window.location.host + '/websocket');
            connection.binaryType = "arraybuffer";


            //This event occurs when socket connection is established.
            connection.onopen = function() {
                console.log("ws opened");
            }

            //This event occurs when connection is closed.
            connection.onclose = function() {
                console.log("ws closed");
            }

            //This event occurs when client receives data from server.
            connection.onmessage = function(e) {
                //console.log("rcvd");
                if(e.data instanceof ArrayBuffer) { //this is binary data
                    console.log("binary data received.. ignoring");
                }
                else { //this is text data such as json
                    if(e.data === "Hello websocket") {
                        console.log(e.data);
                    }
                    else { //json data
                        var obj = JSON.parse(e.data); //this could error based on encodings
                        //console.log(obj);
                        UpdateWithData(obj);

                    }
                    //console.log(e.data);
                }
            }

            //This event occurs when there is any error in communication.
            connection.onerror = function(error) {
                //alert('WebSocket error');
                connection.close();
            }
        } //running http(s)

    });

    function WebSocketSend(str) {
        connection.send(str);
    }
    </script>
</body>
</html>
